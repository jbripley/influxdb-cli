#!/usr/bin/env ruby

require 'rubygems'
require 'influxdb'
require 'pry'
require 'thor'
require 'awesome_print'
require 'terminal-table'

$LOAD_PATH.unshift File.join(File.dirname(__FILE__), '..', 'lib')

require 'influxdb_client/version'
require 'influxdb_client/client'

class InfluxDBClientTasks < Thor
  desc 'db', 'Connect to InfluxDB'
  method_option :host,      :default => 'localhost',  :aliases => '-h',  :desc => 'Hostname'
  method_option :port,      :default => 8086,         :desc => 'Port'
  method_option :username,  :default => 'root',       :aliases => '-u',  :desc => 'Username'
  method_option :password,  :default => 'root',       :aliases => '-p',  :desc => 'Password'
  method_option :database,  :default => 'db',         :aliases => '-d',  :desc => 'Database'
  def db
    puts "Connecting to #{options.inspect}"
    @@db ||= InfluxDB::Client.new options[:database],
      { username: options[:username], password: options[:password], host: options[:host], port: options[:port] }
    puts 'âœ” ready'
  end

  desc 'version', 'Show influxdb-cli version'
  def version
    puts "influxdb-cli #{InfluxDBClient::VERSION}"
    # skip `pry` console
    exit 0
  end

  def self.db; @@db; end

  default_task :db
end

# Returns {InfluxDB::Client} instance using given parameters.
#
# @return [InfluxDB::Client]
def db; InfluxDBClientTasks.db; end

# Queries data using {http://influxdb.org/docs/query_language/ InfluxDB Query Language}
# and prints a tabularized output.
#
# i.e. query('select value from response_times')
#
# @see InfluxDB::Client#query
#
# @return [Hash] the number of points per time series i.e. { 'response_times.count' => 10 }
def query(query)
  result = db.query(query)
  number_of_points = {}
  result.to_h.keys.each do |series|
    headings = result[series].first.keys
    rows = result[series].collect(&:values)
    table = Terminal::Table.new title: series, headings: headings, rows: rows
    puts table
    # empty line between time series output
    puts
    # count total per time series
    number_of_points["#{series}.count"] = result[series].size
  end
  number_of_points
end

# allow typing queries directly from console i.e.`select * from deploys` instead of `query('select * from deploys')`.
# matches `delete from ...` and `select ... from ...`
Pry::Commands.block_command InfluxDBClient::Client::QUERY_LANGUAGE_MATCHER, 'Execute a query' do |cmd|
  query(cmd)
end

InfluxDBClientTasks.start

# awesome_print
Pry.config.print = proc { |output, value| Pry::Helpers::BaseHelpers.stagger_output("=> #{value.ai}", output) }

pry

